<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1202考试系统</title>
    <style>
        /* 全局样式 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 2.2rem;
        }
        
        /* 科目选择界面样式 */
        #subject-selection {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        select, input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        /* 考试界面样式 */
        #exam-interface {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .question {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .question-text {
            font-size: 1.2rem;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .options label {
            display: block;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: normal;
        }
        
        .options label:hover {
            background-color: #f9f9f9;
        }
        
        .options input[type="radio"] {
            margin-right: 10px;
        }
        
        .progress {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        .timer {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 15px;
        }
        
        /* 结果界面样式 */
        #result-interface {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .score-summary {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .score {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .question-review {
            margin-top: 20px;
        }
        
        .review-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        
        .correct {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .incorrect {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        
        .explanation {
            margin-top: 10px;
            padding: 10px;
            background-color: #f1f1f1;
            border-radius: 4px;
            font-size: 0.95rem;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>1202考试系统</h1>
        </header>
        
        <!-- 科目选择界面 -->
        <section id="subject-selection">
            <h2>选择考试科目</h2>
            <div class="form-group">
                <label for="subject-select">科目:</label>
                <select id="subject-select">
                    <option value="">加载中...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="question-count">题目数量:</label>
                <input type="number" id="question-count" min="1" max="50" value="10">
            </div>
            <button id="start-exam">开始考试</button>
        </section>
        
        <!-- 考试界面 -->
        <section id="exam-interface">
            <div class="progress">题目: <span id="current-question">1</span>/<span id="total-questions">10</span></div>
            <div class="timer">剩余时间: <span id="time-remaining">00:00</span></div>
            <div id="questions-container"></div>
            <button id="submit-exam">提交答案</button>
        </section>
        
        <!-- 结果界面 -->
        <section id="result-interface">
            <div class="score-summary">
                <h2>考试结果</h2>
                <div class="score"><span id="score-value">0</span>/<span id="total-score">10</span></div>
                <p>正确: <span id="correct-count">0</span>题 | 错误: <span id="incorrect-count">0</span>题</p>
            </div>
            <div id="questions-review" class="question-review"></div>
            <div class="navigation">
                <button id="retry-exam">重新考试</button>
                <button id="new-exam">选择新科目</button>
            </div>
        </section>
    </div>

    <script>
        // 全局变量
        let currentSubject = null;
        let allQuestions = [];
        let currentExamQuestions = [];
        let userAnswers = [];
        let examStartTime = null;
        let examTimer = null;
        let examDuration = 0; // 考试时长（分钟）
        let userAnswerHistory = JSON.parse(localStorage.getItem('1202ExamSystemHistory')) || {};
        
        // DOM元素
        const subjectSelectionEl = document.getElementById('subject-selection');
        const examInterfaceEl = document.getElementById('exam-interface');
        const resultInterfaceEl = document.getElementById('result-interface');
        const subjectSelectEl = document.getElementById('subject-select');
        const questionCountEl = document.getElementById('question-count');
        const startExamBtn = document.getElementById('start-exam');
        const questionsContainerEl = document.getElementById('questions-container');
        const submitExamBtn = document.getElementById('submit-exam');
        const retryExamBtn = document.getElementById('retry-exam');
        const newExamBtn = document.getElementById('new-exam');

        // 初始化系统
        document.addEventListener('DOMContentLoaded', function() {
            loadSubjectList();
            setupEventListeners();
        });
        
        // 加载科目列表
        async function loadSubjectList() {
            try {
                // 尝试加载科目列表文件（这里简化处理，实际中可能需要一个索引文件）
                // 假设我们已知有5个科目文件
                const subjectCount = 5;
                subjectSelectEl.innerHTML = '<option value="">选择科目...</option>';
                
                for (let i = 1; i <= subjectCount; i++) {
                    const subjectId = i.toString().padStart(4, '0');
					console.log(subjectId);
                    try {
                        const response = await fetch(`subjects/${subjectId}.json`);
                        if (response.ok) {
					console.log("ok");
                            const subjectData = await response.json();
console.log(subjectData);							
                            const option = document.createElement('option');
                            option.value = subjectId;
                            option.textContent = subjectData.subjectName;
                            subjectSelectEl.appendChild(option);
                        }
                    } catch (error) {
                        console.warn(`无法加载科目文件 ${subjectId}.json:`, error);
                    }
                }
                
                if (subjectSelectEl.options.length <= 1) {
                    subjectSelectEl.innerHTML = '<option value="">无法加载科目列表</option>';
                }
            } catch (error) {
                console.error('加载科目列表时出错:', error);
                subjectSelectEl.innerHTML = '<option value="">加载科目列表失败</option>';
            }
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            startExamBtn.addEventListener('click', startExam);
            submitExamBtn.addEventListener('click', submitExam);
            retryExamBtn.addEventListener('click', retryExam);
            newExamBtn.addEventListener('click', newExam);
        }
        
        // 开始考试
        async function startExam() {
            const subjectId = subjectSelectEl.value;
            const questionCount = parseInt(questionCountEl.value);
            
            if (!subjectId) {
                alert('请选择考试科目');
                return;
            }
            
            if (isNaN(questionCount) || questionCount < 1) {
                alert('请输入有效的题目数量');
                return;
            }
            
            try {
                // 加载科目数据
                const response = await fetch(`subjects/${subjectId}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const subjectData = await response.json();
                currentSubject = subjectData;
                allQuestions = subjectData.questions;
                
                // 检查题目数量是否足够
                if (questionCount > allQuestions.length) {
                    alert(`该科目只有 ${allQuestions.length} 道题目，无法抽取 ${questionCount} 道题`);
                    return;
                }
                
                // 根据答题历史筛选题目（优先选择未答对或较少答对的题目）
                currentExamQuestions = selectExamQuestions(allQuestions, questionCount, subjectId);
                
                // 初始化考试状态
                userAnswers = new Array(currentExamQuestions.length).fill(null);
                examDuration = Math.ceil(questionCount * 1.5); // 每道题1.5分钟
                
                // 更新界面
                subjectSelectionEl.style.display = 'none';
                examInterfaceEl.style.display = 'block';
                resultInterfaceEl.style.display = 'none';
                
                // 显示题目
                displayQuestions();
                
                // 开始计时
                startTimer(examDuration * 60); // 转换为秒
                
            } catch (error) {
                console.error('开始考试时出错:', error);
                alert('加载考试科目失败，请重试');
            }
        }
        
        // 根据答题历史选择考试题目
        function selectExamQuestions(allQuestions, questionCount, subjectId) {
            // 获取该科目的答题历史
            const subjectHistory = userAnswerHistory[subjectId] || {};
            
            // 为每道题计算权重（答对次数越少，权重越高）
            const weightedQuestions = allQuestions.map(q => {
                const questionHistory = subjectHistory[q.id] || { correct: 0, lastAnswered: null };
                // 基础权重 + 答对次数越少权重越高 + 近期答对的权重降低
                let weight = 100;
                weight -= questionHistory.correct * 10; // 每答对一次权重降低10
                
                // 如果近期答对过，进一步降低权重
                if (questionHistory.lastAnswered) {
                    const daysSinceLastAnswer = Math.floor((Date.now() - questionHistory.lastAnswered) / (1000 * 60 * 60 * 24));
                    if (daysSinceLastAnswer < 7) { // 一周内答对过的题目权重降低
                        weight -= 20;
                    }
                }
                
                return { question: q, weight: Math.max(1, weight) };
            });
            
            // 根据权重随机选择题目
            const selectedQuestions = [];
            const availableQuestions = [...weightedQuestions];
            
            while (selectedQuestions.length < questionCount && availableQuestions.length > 0) {
                // 计算总权重
                const totalWeight = availableQuestions.reduce((sum, q) => sum + q.weight, 0);
                
                // 随机选择
                let randomValue = Math.random() * totalWeight;
                let selectedIndex = 0;
                
                for (let i = 0; i < availableQuestions.length; i++) {
                    randomValue -= availableQuestions[i].weight;
                    if (randomValue <= 0) {
                        selectedIndex = i;
                        break;
                    }
                }
                
                // 添加选中的题目
                selectedQuestions.push(availableQuestions[selectedIndex].question);
                availableQuestions.splice(selectedIndex, 1);
            }
            
            return selectedQuestions;
        }
        
        // 显示题目
        function displayQuestions() {
            questionsContainerEl.innerHTML = '';
            
            currentExamQuestions.forEach((question, index) => {
                const questionEl = document.createElement('div');
                questionEl.className = 'question';
                questionEl.innerHTML = `
                    <div class="question-text">${index + 1}. ${question.question}</div>
                    <div class="options">
                        ${question.options.map((option, optIndex) => `
                            <label>
                                <input type="radio" name="question-${index}" value="${optIndex}">
                                ${option}
                            </label>
                        `).join('')}
                    </div>
                `;
                
                // 添加选项选择事件
                const radioInputs = questionEl.querySelectorAll('input[type="radio"]');
                radioInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        userAnswers[index] = parseInt(this.value);
                    });
                });
                
                questionsContainerEl.appendChild(questionEl);
            });
            
            // 更新进度显示
            document.getElementById('current-question').textContent = '1';
            document.getElementById('total-questions').textContent = currentExamQuestions.length;
        }
        
        // 开始计时器
        function startTimer(totalSeconds) {
            examStartTime = Date.now();
            const timeRemainingEl = document.getElementById('time-remaining');
            
            clearInterval(examTimer);
            examTimer = setInterval(() => {
                const elapsedSeconds = Math.floor((Date.now() - examStartTime) / 1000);
                const remainingSeconds = Math.max(0, totalSeconds - elapsedSeconds);
                
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                
                timeRemainingEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // 时间到自动提交
                if (remainingSeconds <= 0) {
                    submitExam();
                }
            }, 1000);
        }
        
        // 提交考试
        function submitExam() {
            clearInterval(examTimer);
            
            // 检查是否有未答题目
            const unansweredCount = userAnswers.filter(answer => answer === null).length;
            if (unansweredCount > 0 && !confirm(`您还有 ${unansweredCount} 道题未作答，确定要提交吗？`)) {
                startTimer(examDuration * 60 - Math.floor((Date.now() - examStartTime) / 1000));
                return;
            }
            
            // 计算成绩
            let correctCount = 0;
            const results = [];
            
            currentExamQuestions.forEach((question, index) => {
                const isCorrect = userAnswers[index] === question.correctAnswer;
                if (isCorrect) correctCount++;
                
                results.push({
                    question: question,
                    userAnswer: userAnswers[index],
                    correctAnswer: question.correctAnswer,
                    isCorrect: isCorrect
                });
            });
            
            // 更新答题历史
            updateAnswerHistory(results);
            
            // 显示结果
            displayResults(results, correctCount);
        }
        
        // 更新答题历史
        function updateAnswerHistory(results) {
            const subjectId = subjectSelectEl.value;
            if (!userAnswerHistory[subjectId]) {
                userAnswerHistory[subjectId] = {};
            }
            
            results.forEach(result => {
                const questionId = result.question.id;
                if (!userAnswerHistory[subjectId][questionId]) {
                    userAnswerHistory[subjectId][questionId] = { correct: 0, lastAnswered: null };
                }
                
                if (result.isCorrect) {
                    userAnswerHistory[subjectId][questionId].correct++;
                }
                userAnswerHistory[subjectId][questionId].lastAnswered = Date.now();
            });
            
            // 保存到本地存储
            localStorage.setItem('1202ExamSystemHistory', JSON.stringify(userAnswerHistory));
        }
        
        // 显示考试结果
        function displayResults(results, correctCount) {
            examInterfaceEl.style.display = 'none';
            resultInterfaceEl.style.display = 'block';
            
            // 更新分数显示
            document.getElementById('score-value').textContent = correctCount;
            document.getElementById('total-score').textContent = results.length;
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('incorrect-count').textContent = results.length - correctCount;
            
            // 显示题目回顾
            const questionsReviewEl = document.getElementById('questions-review');
            questionsReviewEl.innerHTML = '<h3>题目详解</h3>';
            
            results.forEach((result, index) => {
                const reviewItemEl = document.createElement('div');
                reviewItemEl.className = `review-item ${result.isCorrect ? 'correct' : 'incorrect'}`;
                
                reviewItemEl.innerHTML = `
                    <div class="question-text">${index + 1}. ${result.question.question}</div>
                    <div>您的答案: ${result.userAnswer !== null ? result.question.options[result.userAnswer] : '未作答'}</div>
                    <div>正确答案: ${result.question.options[result.correctAnswer]}</div>
                    ${result.isCorrect ? 
                        '<div style="color: #28a745; font-weight: bold;">✓ 回答正确</div>' : 
                        '<div style="color: #dc3545; font-weight: bold;">✗ 回答错误</div>'
                    }
                    <div class="explanation">解析: ${result.question.explanation}</div>
                `;
                
                questionsReviewEl.appendChild(reviewItemEl);
            });
        }
        
        // 重新考试
        function retryExam() {
            // 使用相同的科目和题目数量重新考试
            startExam();
        }
        
        // 选择新科目
        function newExam() {
            // 返回科目选择界面
            subjectSelectionEl.style.display = 'block';
            examInterfaceEl.style.display = 'none';
            resultInterfaceEl.style.display = 'none';
        }
    </script>
</body>
</html>
